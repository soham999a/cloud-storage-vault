<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Secure Vault - 3D Experience</title>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>

    <!-- Supabase JS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Firebase SDK v9 with CDN (modular) -->
    <script type="module" src="firebase-config.js"></script>

    <!-- Supabase Storage Integration -->
    <script src="supabase-config.js"></script>

    <!-- Image Compression -->
    <script src="image-compressor.js"></script>

    <!-- Local Storage Fallback -->
    <script src="local-storage.js"></script>

    <!-- Direct Upload Service -->
    <script src="direct-upload.js"></script>

    <!-- Upload Handler -->
    <script src="upload-handler.js"></script>

    <!-- Fast Upload Service -->
    <script src="fast-upload.js"></script>

    <!-- Local-Only Upload Service -->
    <script src="local-only-upload.js"></script>

    <!-- Debug Helper -->
    <script src="debug-helper.js"></script>

    <!-- Simple File Storage -->
    <script src="simple-file-storage.js"></script>

    <!-- Simple Upload Service -->
    <script src="simple-upload-service.js"></script>

    <!-- Debug Storage -->
    <script src="debug-storage.js"></script>

    <!-- Direct File Manager -->
    <script src="direct-file-manager.js"></script>

    <!-- Direct Upload Service -->
    <script src="direct-upload-service.js"></script>

    <!-- Direct Files Display -->
    <script src="direct-files-display.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }

        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .content {
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            background-color: rgba(10, 10, 10, 0.7);
            backdrop-filter: blur(10px);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
            text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        .nav {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            color: #ffffff;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            background-color: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .nav-link.active {
            background-color: #00ff00;
            color: #000000;
        }

        .hero {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 20px;
        }

        .hero h1 {
            font-size: 60px;
            margin-bottom: 20px;
            background: linear-gradient(to right, #00ff00, #00ffff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }

        .hero p {
            font-size: 24px;
            max-width: 800px;
            margin-bottom: 40px;
            color: #cccccc;
        }

        .btn {
            padding: 15px 30px;
            background: linear-gradient(to right, #00ff00, #00ccff);
            color: #000000;
            border: none;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
        }

        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 255, 0, 0.5);
        }

        .features {
            padding: 100px 40px;
            background-color: rgba(10, 10, 10, 0.8);
        }

        .section-title {
            text-align: center;
            font-size: 36px;
            margin-bottom: 60px;
            color: #00ff00;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .feature-card {
            background-color: rgba(26, 26, 26, 0.8);
            border-radius: 10px;
            padding: 30px;
            transition: all 0.3s ease;
            border: 1px solid #333;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        .feature-icon {
            font-size: 40px;
            margin-bottom: 20px;
            color: #00ff00;
        }

        .feature-card h3 {
            font-size: 24px;
            margin-bottom: 15px;
            color: #ffffff;
        }

        .feature-card p {
            color: #cccccc;
            line-height: 1.6;
        }

        .login-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .login-section.active {
            opacity: 1;
            pointer-events: all;
        }

        .login-container {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 40px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            border: 1px solid #333;
            position: relative;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #cccccc;
            font-size: 24px;
            cursor: pointer;
        }

        .login-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #00ff00;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #cccccc;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #ffffff;
            font-size: 16px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .form-footer {
            text-align: center;
            margin-top: 20px;
            color: #cccccc;
        }

        .form-footer a {
            color: #00ff00;
            text-decoration: none;
        }

        .form-footer a:hover {
            text-decoration: underline;
        }

        /* Google Sign-in Button Styles */
        .social-login {
            margin-top: 20px;
            text-align: center;
        }

        .social-login p {
            margin-bottom: 10px;
            color: #cccccc;
            font-size: 14px;
        }

        .google-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #ffffff;
            color: #757575;
            border: 1px solid #dddddd;
            padding: 10px 15px;
            margin: 10px auto;
            width: 100%;
            max-width: 300px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .google-btn:hover {
            background-color: #f5f5f5;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .google-icon {
            width: 18px;
            height: 18px;
            margin-right: 10px;
        }

        /* Loading spinner for Google buttons */
        .loading-spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top-color: #757575;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            background-color: rgba(10, 10, 10, 0.9);
            padding: 40px;
            text-align: center;
            color: #cccccc;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .social-link {
            color: #cccccc;
            font-size: 24px;
            transition: color 0.3s ease;
        }

        .social-link:hover {
            color: #00ff00;
        }

        /* Pricing Styles */
        .pricing {
            padding: 100px 40px;
            background-color: rgba(10, 10, 10, 0.8);
        }

        .pricing-container {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .pricing-card {
            background-color: rgba(26, 26, 26, 0.8);
            border-radius: 10px;
            padding: 40px;
            width: 400px;
            border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0, 255, 0, 0.1);
            transition: all 0.3s ease;
        }

        .pricing-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        .pricing-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .pricing-header h3 {
            font-size: 28px;
            margin-bottom: 20px;
            color: #00ff00;
        }

        .price {
            font-size: 24px;
            color: #ffffff;
        }

        .currency {
            font-size: 24px;
            vertical-align: top;
        }

        .amount {
            font-size: 60px;
            font-weight: bold;
            color: #00ff00;
        }

        .period {
            font-size: 18px;
            color: #cccccc;
        }

        .pricing-features {
            margin-bottom: 30px;
        }

        .pricing-features ul {
            list-style: none;
            padding: 0;
        }

        .pricing-features li {
            padding: 10px 0;
            color: #cccccc;
            font-size: 18px;
        }

        .pricing-btn {
            width: 100%;
        }

        /* Contact Styles */
        .contact {
            padding: 100px 40px;
            background-color: rgba(10, 10, 10, 0.9);
        }

        .contact-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .contact-form-container {
            background-color: rgba(26, 26, 26, 0.8);
            border-radius: 10px;
            padding: 40px;
            border: 1px solid #333;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        textarea {
            width: 100%;
            padding: 12px;
            background-color: #333;
            border: 1px solid #444;
            border-radius: 4px;
            color: #ffffff;
            font-size: 16px;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .contact-info {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .contact-info-item {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            background-color: rgba(26, 26, 26, 0.8);
            border-radius: 10px;
            padding: 30px;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .contact-info-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        .contact-info-icon {
            font-size: 30px;
            color: #00ff00;
        }

        .contact-info-content h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .contact-info-content p {
            color: #cccccc;
        }

        /* Dashboard Styles */
        .dashboard-container {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 40px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            border: 1px solid #333;
            position: relative;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: rgba(26, 26, 26, 0.8);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 10px;
            color: #00ff00;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .stat-label {
            font-size: 14px;
            color: #cccccc;
        }

        .dashboard-actions {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-actions .btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-icon {
            font-size: 20px;
        }

        .files-container {
            background-color: rgba(26, 26, 26, 0.8);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #333;
        }

        .files-container h3 {
            margin-bottom: 20px;
            color: #ffffff;
            font-size: 20px;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
            color: #333;
        }

        .empty-state p {
            margin-bottom: 20px;
            color: #cccccc;
            font-size: 18px;
        }

        /* File list styles */
        .file-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #333;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background-color: rgba(0, 255, 0, 0.05);
        }

        .file-icon {
            font-size: 24px;
            margin-right: 15px;
            color: #cccccc;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .file-meta {
            font-size: 12px;
            color: #999;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        .file-action-btn {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .file-action-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* Enhanced Dashboard Styles */
        .dashboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .tab-btn {
            padding: 10px 20px;
            background-color: rgba(26, 26, 26, 0.8);
            border: 1px solid #333;
            border-radius: 20px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .tab-btn.active, .tab-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            color: #00ff00;
        }

        .search-container {
            display: flex;
            margin-bottom: 20px;
        }

        .search-input {
            flex: 1;
            padding: 12px 15px;
            background-color: rgba(26, 26, 26, 0.8);
            border: 1px solid #333;
            border-radius: 4px 0 0 4px;
            color: #ffffff;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        .search-btn {
            padding: 12px 15px;
            background-color: rgba(0, 255, 0, 0.2);
            border: 1px solid #00ff00;
            border-left: none;
            border-radius: 0 4px 4px 0;
            color: #00ff00;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-btn:hover {
            background-color: rgba(0, 255, 0, 0.3);
        }

        .files-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .view-options {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            padding: 5px 10px;
            background-color: rgba(26, 26, 26, 0.8);
            border: 1px solid #333;
            border-radius: 4px;
            color: #cccccc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active, .view-btn:hover {
            background-color: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            color: #00ff00;
        }

        /* Grid View Styles */
        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .file-card {
            background-color: rgba(26, 26, 26, 0.8);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }

        .file-thumbnail {
            width: 80px;
            height: 80px;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .file-name {
            font-size: 14px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-info {
            font-size: 12px;
            color: #999;
        }

        /* Upload Modal Styles */
        .upload-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .upload-modal.active {
            display: flex;
        }

        .upload-modal-content {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            border: 1px solid #333;
        }

        .upload-modal-content h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #00ff00;
        }

        .file-upload-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            color: #cccccc;
        }

        .upload-status {
            margin-top: 10px;
            color: #00ff00;
            font-size: 14px;
            text-align: center;
        }

        .upload-tips {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(0, 255, 0, 0.1);
            border: 1px solid rgba(0, 255, 0, 0.3);
            border-radius: 5px;
        }

        .upload-tips p {
            margin-bottom: 8px;
            color: #00ff00;
        }

        .upload-tips ul {
            padding-left: 20px;
            color: #cccccc;
            font-size: 14px;
        }

        .upload-limit {
            color: #00ff00;
            font-size: 14px;
            margin-top: 10px;
            font-weight: bold;
            background-color: rgba(0, 255, 0, 0.1);
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .upload-tips li {
            margin-bottom: 5px;
        }

        .cancel-btn {
            background: linear-gradient(to right, #ff3333, #ff6666);
            margin-top: 20px;
        }

        /* File Preview Modal Styles */
        .file-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .file-preview-modal.active {
            display: flex;
        }

        .file-preview-content {
            background-color: #1a1a1a;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 30px rgba(0, 255, 0, 0.3);
            border: 1px solid #333;
            position: relative;
        }

        .file-preview-container {
            margin: 20px 0;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(26, 26, 26, 0.8);
            border-radius: 8px;
            padding: 20px;
        }

        .file-preview-container img {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
        }

        .file-preview-container video {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
        }

        .file-preview-container audio {
            width: 100%;
        }

        .file-preview-container .pdf-preview {
            width: 100%;
            height: 500px;
            border: none;
        }

        .file-preview-container .text-preview {
            width: 100%;
            height: 300px;
            background-color: #333;
            color: #ffffff;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow: auto;
        }

        .file-actions-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .delete-btn {
            background: linear-gradient(to right, #ff3333, #ff6666);
        }

        /* Upload progress styles */
        .upload-progress {
            padding: 20px;
            text-align: center;
        }

        .upload-progress h3 {
            margin-bottom: 15px;
            color: #ffffff;
        }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #333;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #00ff00, #00ffff);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 14px;
            color: #cccccc;
        }

        .upload-success {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-success p {
            font-size: 18px;
            color: #00ff00;
        }

        /* File type icons */
        .file-icon-pdf { color: #ff4444; }
        .file-icon-doc { color: #4444ff; }
        .file-icon-xls { color: #44aa44; }
        .file-icon-ppt { color: #ff8844; }
        .file-icon-img { color: #44dddd; }
        .file-icon-vid { color: #dd44dd; }
        .file-icon-aud { color: #dddd44; }
        .file-icon-zip { color: #888888; }
        .file-icon-txt { color: #ffffff; }

        /* Local file indicator */
        .local-badge {
            display: inline-block;
            background-color: #00ff00;
            color: #000000;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            font-weight: bold;
        }

        .local-file {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }

        @media (max-width: 768px) {
            .hero h1 {
                font-size: 40px;
            }

            .hero p {
                font-size: 18px;
            }

            .nav {
                display: none;
            }

            .contact-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>

    <div class="content">
        <header class="header">
            <div class="logo">Cloud Secure Vault</div>
            <nav class="nav">
                <a href="#" class="nav-link active">Home</a>
                <a href="#features" class="nav-link">Features</a>
                <a href="#pricing" class="nav-link">Pricing</a>
                <a href="#contact" class="nav-link">Contact</a>
                <a href="#" class="nav-link" id="login-link">Login</a>
            </nav>
        </header>

        <section class="hero">
            <h1>Secure Cloud Storage Solution</h1>
            <p>Store, manage, and share your files securely with our advanced cloud storage platform powered by cutting-edge encryption technology.</p>
            <button class="btn" id="get-started-btn">Get Started</button>
        </section>

        <section class="features" id="features">
            <h2 class="section-title">Key Features</h2>
            <div class="features-grid">
                <div class="feature-card">
                    <div class="feature-icon">🔒</div>
                    <h3>End-to-End Encryption</h3>
                    <p>Your files are encrypted before they leave your device and can only be decrypted by you. We use military-grade AES-256 encryption to ensure your data remains private.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔄</div>
                    <h3>Easy File Sharing</h3>
                    <p>Share files and folders with anyone, with customizable access controls and expiration dates. Set permissions for viewing, editing, or downloading shared content.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">⚡</div>
                    <h3>Automatic Backup</h3>
                    <p>Set up automatic backups to ensure your important files are always protected. Schedule backups at your preferred frequency and never worry about data loss again.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📱</div>
                    <h3>Cross-Platform Access</h3>
                    <p>Access your files from any device - desktop, mobile, or web. Our applications are available for Windows, macOS, iOS, and Android with seamless synchronization.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">🔍</div>
                    <h3>Advanced Search</h3>
                    <p>Quickly find any file with our powerful search capabilities. Search by filename, content, tags, or metadata to locate your files instantly.</p>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">📊</div>
                    <h3>Storage Analytics</h3>
                    <p>Get insights into your storage usage with detailed analytics. Understand what's taking up space and optimize your storage efficiently.</p>
                </div>
            </div>
        </section>

        <section class="pricing" id="pricing">
            <h2 class="section-title">Simple Pricing</h2>
            <div class="pricing-container">
                <div class="pricing-card">
                    <div class="pricing-header">
                        <h3>Premium Plan</h3>
                        <div class="price">
                            <span class="currency">$</span>
                            <span class="amount">19</span>
                            <span class="period">/month</span>
                        </div>
                    </div>
                    <div class="pricing-features">
                        <ul>
                            <li>✅ 1TB Secure Storage</li>
                            <li>✅ End-to-End Encryption</li>
                            <li>✅ Unlimited File Sharing</li>
                            <li>✅ Advanced File Recovery</li>
                            <li>✅ 24/7 Priority Support</li>
                            <li>✅ Cross-Platform Access</li>
                            <li>✅ Advanced Analytics</li>
                        </ul>
                    </div>
                    <button class="btn pricing-btn">Get Started</button>
                </div>
            </div>
        </section>

        <section class="contact" id="contact">
            <h2 class="section-title">Contact Us</h2>
            <div class="contact-container">
                <div class="contact-form-container">
                    <form id="contact-form">
                        <div class="form-group">
                            <label for="contact-name">Name</label>
                            <input type="text" id="contact-name" required>
                        </div>
                        <div class="form-group">
                            <label for="contact-email">Email</label>
                            <input type="email" id="contact-email" required>
                        </div>
                        <div class="form-group">
                            <label for="contact-subject">Subject</label>
                            <input type="text" id="contact-subject" required>
                        </div>
                        <div class="form-group">
                            <label for="contact-message">Message</label>
                            <textarea id="contact-message" rows="5" required></textarea>
                        </div>
                        <button type="submit" class="btn" style="width: 100%;">Send Message</button>
                    </form>
                </div>
                <div class="contact-info">
                    <div class="contact-info-item">
                        <div class="contact-info-icon">📍</div>
                        <div class="contact-info-content">
                            <h3>Address</h3>
                            <p>123 Security Street, Cloud City, CC 10101</p>
                        </div>
                    </div>
                    <div class="contact-info-item">
                        <div class="contact-info-icon">📧</div>
                        <div class="contact-info-content">
                            <h3>Email</h3>
                            <p>support@cloudsecurevault.com</p>
                        </div>
                    </div>
                    <div class="contact-info-item">
                        <div class="contact-info-icon">📞</div>
                        <div class="contact-info-content">
                            <h3>Phone</h3>
                            <p>+1 (555) 123-4567</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer">
            <div class="social-links">
                <a href="#" class="social-link">📘</a>
                <a href="#" class="social-link">🐦</a>
                <a href="#" class="social-link">📸</a>
                <a href="#" class="social-link">📱</a>
            </div>
            <p>&copy; 2025 Cloud Secure Vault. All rights reserved.</p>
        </footer>
    </div>

    <div class="login-section" id="login-section">
        <div class="login-container">
            <button class="close-btn" id="close-login">&times;</button>
            <h2>Login to Your Account</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Login</button>
                <div class="social-login">
                    <p>Or login with:</p>
                    <button type="button" class="btn google-btn" id="google-login-btn">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="google-icon">
                        Sign in with Google
                    </button>
                </div>
                <div class="form-footer">
                    <p>Don't have an account? <a href="#" id="register-link">Register</a></p>
                </div>
            </form>
        </div>
    </div>

    <div class="login-section" id="register-section">
        <div class="login-container">
            <button class="close-btn" id="close-register">&times;</button>
            <h2>Create an Account</h2>
            <form id="register-form">
                <div class="form-group">
                    <label for="reg-name">Full Name</label>
                    <input type="text" id="reg-name" required>
                </div>
                <div class="form-group">
                    <label for="reg-email">Email</label>
                    <input type="email" id="reg-email" required>
                </div>
                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input type="password" id="reg-password" required>
                </div>
                <div class="form-group">
                    <label for="reg-confirm-password">Confirm Password</label>
                    <input type="password" id="reg-confirm-password" required>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Register</button>
                <div class="social-login">
                    <p>Or register with:</p>
                    <button type="button" class="btn google-btn" id="google-register-btn">
                        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google" class="google-icon">
                        Sign up with Google
                    </button>
                </div>
                <div class="form-footer">
                    <p>Already have an account? <a href="#" id="login-link-2">Login</a></p>
                </div>
            </form>
        </div>
    </div>

    <div class="login-section" id="dashboard-section">
        <div class="dashboard-container">
            <button class="close-btn" id="close-dashboard">&times;</button>
            <h2>Your Secure Dashboard</h2>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon">💾</div>
                    <div class="stat-value">0 GB</div>
                    <div class="stat-label">Used Storage</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📁</div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Files</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">🔗</div>
                    <div class="stat-value">0</div>
                    <div class="stat-label">Shared Files</div>
                </div>
            </div>

            <div class="dashboard-tabs">
                <button class="tab-btn active" data-tab="all-files">All Files</button>
                <button class="tab-btn" data-tab="documents">Documents</button>
                <button class="tab-btn" data-tab="images">Images</button>
                <button class="tab-btn" data-tab="videos">Videos</button>
                <button class="tab-btn" data-tab="audio">Audio</button>
            </div>

            <div class="dashboard-actions">
                <button class="btn" id="upload-btn">
                    <span class="btn-icon">📤</span> Upload Files (5MB max)
                </button>
                <button class="btn" id="create-folder-btn">
                    <span class="btn-icon">📂</span> New Folder
                </button>
            </div>

            <div class="search-container">
                <input type="text" id="file-search" placeholder="Search your files..." class="search-input">
                <button class="search-btn">🔍</button>
            </div>

            <div class="files-container">
                <div class="files-header">
                    <h3>Your Files</h3>
                    <div class="view-options">
                        <button class="view-btn active" data-view="grid">Grid</button>
                        <button class="view-btn" data-view="list">List</button>
                    </div>
                </div>

                <div class="files-list">
                    <div class="empty-state">
                        <div class="empty-icon">📤</div>
                        <p>You haven't uploaded any files yet.</p>
                        <p class="upload-limit">Free users: 5MB maximum file size</p>
                        <button class="btn" id="upload-btn-empty">Upload Your First File (5MB max)</button>
                    </div>
                </div>
            </div>

            <!-- Upload Progress Modal -->
            <div class="upload-modal" id="upload-modal">
                <div class="upload-modal-content">
                    <h3>Uploading Files</h3>
                    <div class="upload-progress-container">
                        <div class="file-upload-info">
                            <span id="current-file-name">file.pdf</span>
                            <span id="upload-count">1/3</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="upload-progress-bar"></div>
                        </div>
                        <div class="progress-text" id="upload-progress-text">0%</div>
                        <div class="upload-status" id="upload-status">Preparing upload...</div>
                    </div>
                    <div class="upload-tips">
                        <p><strong>Tips:</strong></p>
                        <ul>
                            <li>Maximum file size: 5MB for free users</li>
                            <li>Keep this window open during upload</li>
                            <li>Files are stored locally in your browser</li>
                            <li>If upload seems stuck, try cancelling and uploading a smaller file</li>
                        </ul>
                    </div>
                    <button class="btn cancel-btn" id="cancel-upload-btn">Cancel</button>
                </div>
            </div>

            <!-- File Preview Modal -->
            <div class="file-preview-modal" id="file-preview-modal">
                <div class="file-preview-content">
                    <button class="close-btn" id="close-preview">&times;</button>
                    <h3 id="preview-file-name">File Name</h3>
                    <div class="file-preview-container" id="file-preview-container">
                        <!-- Preview content will be inserted here -->
                    </div>
                    <div class="file-actions-bar">
                        <button class="btn" id="download-file-btn">Download</button>
                        <button class="btn" id="share-file-btn">Share</button>
                        <button class="btn delete-btn" id="delete-file-btn">Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Show notification about file size limit when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                showNotification('info', 'Free users can upload files up to 5MB', 5000);

                // Test local storage functionality
                window.testLocalStorage();

                // Initialize the direct file manager
                setTimeout(() => {
                    if (window.firebaseServices?.auth?.currentUser) {
                        console.log('Initializing direct file manager on page load');
                        window.directFileManager.updateUI();
                    }
                }, 1000);
            }, 2000);
        });

        // Three.js setup
        let scene, camera, renderer, controls;
        let particles = [];

        function init() {
            // Create scene
            scene = new THREE.Scene();

            // Create camera
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 50;

            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Add controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = false;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;

            // Create particles
            createParticles();

            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0x00ff00, 1);
            directionalLight.position.set(10, 10, 10);
            scene.add(directionalLight);

            // Handle window resize
            window.addEventListener('resize', onWindowResize);

            // Start animation loop
            animate();
        }

        function createParticles() {
            // Create particle geometry
            const particleGeometry = new THREE.BufferGeometry();
            const particleCount = 2000;

            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            const sizes = new Float32Array(particleCount);

            const color = new THREE.Color();

            for (let i = 0; i < particleCount; i++) {
                // Position
                const x = (Math.random() - 0.5) * 100;
                const y = (Math.random() - 0.5) * 100;
                const z = (Math.random() - 0.5) * 100;

                positions[i * 3] = x;
                positions[i * 3 + 1] = y;
                positions[i * 3 + 2] = z;

                // Color
                const colorIndex = Math.random();
                if (colorIndex < 0.33) {
                    color.setRGB(0, 1, 0); // Green
                } else if (colorIndex < 0.66) {
                    color.setRGB(0, 1, 1); // Cyan
                } else {
                    color.setRGB(0, 0.5, 1); // Blue
                }

                colors[i * 3] = color.r;
                colors[i * 3 + 1] = color.g;
                colors[i * 3 + 2] = color.b;

                // Size
                sizes[i] = Math.random() * 2;
            }

            particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            particleGeometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // Create particle material
            const particleMaterial = new THREE.PointsMaterial({
                size: 0.5,
                vertexColors: true,
                transparent: true,
                opacity: 0.8,
                sizeAttenuation: true
            });

            // Create particle system
            const particleSystem = new THREE.Points(particleGeometry, particleMaterial);
            scene.add(particleSystem);

            // Store particle system for animation
            particles.push({
                system: particleSystem,
                initialPositions: positions.slice()
            });
        }

        function animate() {
            requestAnimationFrame(animate);

            // Animate particles
            const time = Date.now() * 0.001;

            particles.forEach(particle => {
                const positions = particle.system.geometry.attributes.position.array;
                const initialPositions = particle.initialPositions;

                for (let i = 0; i < positions.length; i += 3) {
                    const x = initialPositions[i];
                    const y = initialPositions[i + 1];
                    const z = initialPositions[i + 2];

                    positions[i] = x + Math.sin(time + x * 0.05) * 0.3;
                    positions[i + 1] = y + Math.sin(time + y * 0.05) * 0.3;
                    positions[i + 2] = z + Math.sin(time + z * 0.05) * 0.3;
                }

                particle.system.geometry.attributes.position.needsUpdate = true;
            });

            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Initialize Three.js scene
        init();

        // UI Interactions
        document.getElementById('login-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-section').classList.add('active');
        });

        document.getElementById('close-login').addEventListener('click', function() {
            document.getElementById('login-section').classList.remove('active');
        });

        document.getElementById('register-link').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('login-section').classList.remove('active');
            document.getElementById('register-section').classList.add('active');
        });

        document.getElementById('login-link-2').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('register-section').classList.remove('active');
            document.getElementById('login-section').classList.add('active');
        });

        document.getElementById('close-register').addEventListener('click', function() {
            document.getElementById('register-section').classList.remove('active');
        });

        // Get Started button functionality
        const getStartedBtn = document.getElementById('get-started-btn');
        getStartedBtn.addEventListener('click', function() {
            // If user is logged in, show dashboard, otherwise show register form
            if (currentUser) {
                showDashboard(currentUser);
            } else {
                document.getElementById('register-section').classList.add('active');
            }
        });

        // Firebase Authentication with v9 SDK
        let currentUser = null;

        // Check if Firebase is initialized properly
        console.log('Waiting for Firebase to initialize...');

        // Function to initialize Firebase auth state listener
        function initializeFirebaseAuth() {
            if (window.firebaseServices) {
                console.log('Firebase services available, setting up auth listener');

                // Check if user is already logged in
                window.firebaseServices.onAuthStateChanged(function(user) {
                    if (user) {
                        // User is signed in
                        console.log('User signed in:', user.email);
                        currentUser = user;
                        updateUIForLoggedInUser(user);
                    } else {
                        // User is signed out
                        console.log('No user signed in');
                        currentUser = null;
                        updateUIForLoggedOutUser();
                    }
                });
            } else {
                console.log('Firebase services not yet available, retrying in 500ms');
                setTimeout(initializeFirebaseAuth, 500);
            }
        }

        // Start the initialization process
        initializeFirebaseAuth();

        function updateUIForLoggedInUser(user) {
            // Update login button
            const loginLink = document.getElementById('login-link');
            loginLink.textContent = 'Dashboard';
            loginLink.href = '#';

            // Remove existing event listeners by cloning the node
            const newLoginLink = loginLink.cloneNode(true);
            loginLink.parentNode.replaceChild(newLoginLink, loginLink);

            // Add the event listener to the new node
            newLoginLink.addEventListener('click', function(e) {
                e.preventDefault();
                showDashboard(user);
            });

            // Update Get Started button to show Dashboard
            const getStartedBtn = document.getElementById('get-started-btn');
            getStartedBtn.textContent = 'Dashboard';

            // Add logout button
            const nav = document.querySelector('.nav');
            if (!document.getElementById('logout-link')) {
                const logoutLink = document.createElement('a');
                logoutLink.href = '#';
                logoutLink.className = 'nav-link';
                logoutLink.id = 'logout-link';
                logoutLink.textContent = 'Logout';
                logoutLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (window.firebaseServices) {
                        window.firebaseServices.signOut().then(function() {
                            // Sign-out successful
                            alert('You have been logged out');
                            // Track logout event
                            window.firebaseServices.logAnalyticsEvent('logout', {});
                        }).catch(function(error) {
                            // An error happened
                            console.error('Logout error:', error);
                            alert('Error signing out. Please try again.');
                        });
                    } else {
                        console.error('Firebase services not available');
                        alert('Error: Firebase services not available. Please try again later.');
                    }
                });
                nav.appendChild(logoutLink);
            }

            // Setup dashboard close button
            document.getElementById('close-dashboard').addEventListener('click', function() {
                document.getElementById('dashboard-section').classList.remove('active');
            });

            // Setup upload buttons with our direct file upload
            document.getElementById('upload-btn').addEventListener('click', function() {
                if (window.directFilesDisplay) {
                    window.directFilesDisplay.createRealFileFromUpload();
                } else {
                    handleFileUpload();
                }
            });

            document.getElementById('upload-btn-empty').addEventListener('click', function() {
                if (window.directFilesDisplay) {
                    window.directFilesDisplay.createRealFileFromUpload();
                } else {
                    handleFileUpload();
                }
            });

            // Setup create folder button
            document.getElementById('create-folder-btn').addEventListener('click', function() {
                const folderName = prompt('Enter folder name:');
                if (folderName) {
                    alert(`Folder "${folderName}" created successfully!`);
                    // In a real app, you would create the folder in Firebase
                }
            });

            // Setup file preview modal close button
            document.getElementById('close-preview').addEventListener('click', function() {
                document.getElementById('file-preview-modal').classList.remove('active');
            });

            // Setup dashboard tabs
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Get category from data attribute
                    const category = this.dataset.tab;

                    // Fetch files for the selected category
                    const user = window.firebaseServices.auth.currentUser;
                    if (user) {
                        fetchUserFiles(user.uid, category);
                    }
                });
            });

            // Setup view options
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all view buttons
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));

                    // Add active class to clicked button
                    this.classList.add('active');

                    // Get view type from data attribute
                    const viewType = this.dataset.view;

                    // Refresh file list with current view
                    const user = window.firebaseServices.auth.currentUser;
                    if (user) {
                        const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                        fetchUserFiles(user.uid, activeTab);
                    }
                });
            });

            // Setup search functionality
            const searchInput = document.getElementById('file-search');
            const searchBtn = document.querySelector('.search-btn');

            function performSearch() {
                const searchTerm = searchInput.value.trim().toLowerCase();
                if (!searchTerm) return;

                const user = window.firebaseServices.auth.currentUser;
                if (!user) return;

                // Get all files from Firestore
                window.firebaseServices.db.collection('files')
                    .where('userId', '==', user.uid)
                    .get()
                    .then(querySnapshot => {
                        const filesList = document.querySelector('.files-list');
                        const currentView = document.querySelector('.view-btn.active').dataset.view;

                        // Filter files by search term
                        const filteredDocs = [];
                        querySnapshot.forEach(doc => {
                            const file = doc.data();
                            if (file.name.toLowerCase().includes(searchTerm)) {
                                filteredDocs.push(doc);
                            }
                        });

                        if (filteredDocs.length === 0) {
                            filesList.innerHTML = `
                                <div class="empty-state">
                                    <div class="empty-icon">🔍</div>
                                    <p>No files found matching "${searchTerm}"</p>
                                    <button class="btn" id="clear-search-btn">Clear Search</button>
                                </div>
                            `;

                            document.getElementById('clear-search-btn').addEventListener('click', function() {
                                searchInput.value = '';
                                const activeTab = document.querySelector('.tab-btn.active').dataset.tab;
                                fetchUserFiles(user.uid, activeTab);
                            });
                        } else {
                            // Create a custom QuerySnapshot-like object
                            const customQuerySnapshot = {
                                forEach: callback => filteredDocs.forEach(callback),
                                empty: filteredDocs.length === 0
                            };

                            // Display files based on current view
                            if (currentView === 'grid') {
                                displayFilesGrid(filesList, customQuerySnapshot);
                            } else {
                                displayFilesList(filesList, customQuerySnapshot);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error searching files:', error);
                    });
            }

            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        }

        function showDashboard(user) {
            document.getElementById('dashboard-section').classList.add('active');

            // Update dashboard with user info
            const dashboardTitle = document.querySelector('.dashboard-container h2');
            dashboardTitle.textContent = `${user.displayName || 'User'}'s Secure Dashboard`;

            // Display files using our direct files display
            if (window.directFilesDisplay) {
                console.log('Displaying files from localStorage');
                window.directFilesDisplay.displayFilesFromLocalStorage();
            }

            // Track dashboard view event with analytics
            if (window.firebaseServices) {
                window.firebaseServices.logAnalyticsEvent('dashboard_view', {});
            }

            // Fetch user data from Firestore
            if (window.firebaseServices) {
                // Use the getUserDocument function from our Firebase services
                window.firebaseServices.getUserDocument(user.uid).then((userData) => {
                    // userData will be null if document doesn't exist
                    if (userData) {
                        // User document exists, update dashboard with data
                        updateDashboardStats(userData);
                        fetchUserFiles(user.uid);
                    } else {
                        // User document doesn't exist, create it
                        window.firebaseServices.createUserDocument(user.uid, {
                            name: user.displayName || '',
                            email: user.email,
                            storageUsed: 0,
                            fileCount: 0,
                            sharedFiles: 0
                        }).then(() => {
                            // Show empty state
                            updateDashboardStats({
                                storageUsed: 0,
                                fileCount: 0,
                                sharedFiles: 0
                            });
                        }).catch(error => {
                            console.error('Error creating user document:', error);
                        });
                    }
                }).catch(error => {
                    console.error('Error fetching user data:', error);
                });
            } else {
                // Firestore not available, show default empty state
                updateDashboardStats({
                    storageUsed: 0,
                    fileCount: 0,
                    sharedFiles: 0
                });
            }
        }

        function updateDashboardStats(userData) {
            // Update storage usage
            const storageValue = document.querySelector('.stat-card:nth-child(1) .stat-value');
            const storageUsedGB = userData.storageUsed ? (userData.storageUsed / (1024 * 1024 * 1024)).toFixed(2) : 0;
            storageValue.textContent = `${storageUsedGB} GB`;

            // Update file count
            const fileCountValue = document.querySelector('.stat-card:nth-child(2) .stat-value');
            fileCountValue.textContent = userData.fileCount || 0;

            // Update shared files
            const sharedFilesValue = document.querySelector('.stat-card:nth-child(3) .stat-value');
            sharedFilesValue.textContent = userData.sharedFiles || 0;
        }

        async function fetchUserFiles(userId, category = 'all-files') {
            if (!window.firebaseServices) return;

            try {
                // Get cloud files collection for this user
                let query = window.firebaseServices.db.collection('files')
                    .where('userId', '==', userId);

                // Filter by category if not 'all-files'
                if (category !== 'all-files') {
                    query = query.where('category', '==', category);
                }

                // Order by creation date
                query = query.orderBy('createdAt', 'desc');

                const querySnapshot = await query.get();

                // Get local files from simple upload service
                let localFiles = [];
                try {
                    debugLog('Fetching local files from simple upload service');
                    localFiles = await window.simpleUploadService.getFiles(userId);

                    // Log the files we found
                    console.log('Local files found:', localFiles);

                    // Make sure each file has the required properties
                    localFiles = localFiles.map(file => {
                        // Ensure file has an ID
                        if (!file.id) {
                            file.id = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }

                        // Ensure file has isLocal flag
                        file.isLocal = true;

                        // Ensure file has createdAt timestamp
                        if (!file.createdAt) {
                            file.createdAt = new Date().toISOString();
                        }

                        return file;
                    });

                    // Filter by category if needed
                    if (category !== 'all-files') {
                        localFiles = localFiles.filter(file => getFileCategory(file.type, file.name) === category);
                    }

                    debugLog(`Retrieved ${localFiles.length} local files`, 'success');
                } catch (localError) {
                    debugLog('Error fetching local files: ' + localError.message, 'error');
                }

                // Combine cloud and local files
                const allFiles = [];

                // Add cloud files
                querySnapshot.forEach(doc => {
                    const fileData = doc.data();
                    allFiles.push({
                        id: doc.id,
                        ...fileData,
                        isLocal: false
                    });
                });

                // Add local files
                if (localFiles && localFiles.length > 0) {
                    debugLog(`Adding ${localFiles.length} local files to display`, 'info');
                    localFiles.forEach(file => {
                        allFiles.push({
                            ...file,
                            isLocal: true,
                            category: getFileCategory(file.type, file.name)
                        });
                    });
                } else {
                    debugLog('No local files found to display', 'info');
                }

                // Sort by creation date (newest first)
                allFiles.sort((a, b) => {
                    const dateA = a.createdAt instanceof Date ? a.createdAt : new Date(a.createdAt);
                    const dateB = b.createdAt instanceof Date ? b.createdAt : new Date(b.createdAt);
                    return dateB - dateA;
                });

                const filesList = document.querySelector('.files-list');
                const currentView = document.querySelector('.view-btn.active').dataset.view;

                if (allFiles.length === 0) {
                    // No files found, show empty state
                    filesList.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📤</div>
                            <p>You haven't uploaded any files yet.</p>
                            <button class="btn" id="upload-btn-empty">Upload Your First File</button>
                        </div>
                    `;

                    // Add event listener to the new button
                    document.getElementById('upload-btn-empty').addEventListener('click', handleFileUpload);
                } else {
                    // Create a custom QuerySnapshot-like object for our display functions
                    const customSnapshot = {
                        forEach: callback => allFiles.forEach(callback),
                        empty: allFiles.length === 0,
                        length: allFiles.length // Add length property for our debug logs
                    };

                    // Log the files we're about to display
                    debugLog(`Displaying ${allFiles.length} files (${querySnapshot.size || 0} cloud, ${localFiles.length || 0} local)`, 'info');

                    // Files found, display them based on current view
                    if (currentView === 'grid') {
                        displayFilesGrid(filesList, customSnapshot);
                    } else {
                        displayFilesList(filesList, customSnapshot);
                    }
                }
            } catch (error) {
                console.error('Error fetching files:', error);
            }
        }

        function displayFilesGrid(container, querySnapshot) {
            debugLog(`Displaying ${querySnapshot.length} files in grid view`);
            let filesHTML = '<div class="files-grid">';

            querySnapshot.forEach((fileData) => {
                // Handle both Firestore docs and our custom file objects
                const file = fileData.data ? fileData.data() : fileData;
                const fileId = fileData.id || file.id;

                // Skip files without an ID
                if (!fileId) {
                    console.warn('File without ID:', file);
                    return;
                }

                const fileIcon = getFileIcon(file.type, file.name);

                // Handle date formatting for both Firestore Timestamps and regular Dates
                let fileDate;
                if (file.createdAt && typeof file.createdAt.toDate === 'function') {
                    fileDate = formatDate(file.createdAt.toDate());
                } else if (file.createdAt instanceof Date) {
                    fileDate = formatDate(file.createdAt);
                } else {
                    fileDate = formatDate(new Date(file.createdAt));
                }

                // Add local storage indicator if file is stored locally
                const localBadge = file.isLocal ? '<span class="local-badge">Local</span>' : '';

                filesHTML += `
                    <div class="file-card ${file.isLocal ? 'local-file' : ''}" data-id="${fileId}" data-url="${file.url}" data-type="${file.type}" data-name="${file.name}" data-is-local="${file.isLocal ? 'true' : 'false'}">
                        <div class="file-thumbnail ${fileIcon.class}">${fileIcon.icon}</div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-info">${formatFileSize(file.size)} • ${fileDate} ${localBadge}</div>
                    </div>
                `;
            });

            filesHTML += '</div>';
            container.innerHTML = filesHTML;

            // Add event listeners to file cards
            document.querySelectorAll('.file-card').forEach(card => {
                card.addEventListener('click', handleFilePreview);
            });
        }

        function displayFilesList(container, querySnapshot) {
            debugLog(`Displaying ${querySnapshot.length} files in list view`);
            let filesHTML = '';

            querySnapshot.forEach((fileData) => {
                // Handle both Firestore docs and our custom file objects
                const file = fileData.data ? fileData.data() : fileData;
                const fileId = fileData.id || file.id;

                // Skip files without an ID
                if (!fileId) {
                    console.warn('File without ID:', file);
                    return;
                }

                const fileIcon = getFileIcon(file.type, file.name);

                // Handle date formatting for both Firestore Timestamps and regular Dates
                let fileDate;
                if (file.createdAt && typeof file.createdAt.toDate === 'function') {
                    fileDate = formatDate(file.createdAt.toDate());
                } else if (file.createdAt instanceof Date) {
                    fileDate = formatDate(file.createdAt);
                } else {
                    fileDate = formatDate(new Date(file.createdAt));
                }

                // Add local storage indicator if file is stored locally
                const localBadge = file.isLocal ? '<span class="local-badge">Local</span>' : '';

                filesHTML += `
                    <div class="file-item ${file.isLocal ? 'local-file' : ''}" data-id="${fileId}" data-url="${file.url}" data-type="${file.type}" data-name="${file.name}" data-is-local="${file.isLocal ? 'true' : 'false'}">
                        <div class="file-icon ${fileIcon.class}">${fileIcon.icon}</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-meta">${formatFileSize(file.size)} • ${fileDate} ${localBadge}</div>
                        </div>
                        <div class="file-actions">
                            <button class="file-action-btn download-btn" title="Download">⬇️</button>
                            <button class="file-action-btn share-btn" title="Share">🔗</button>
                            <button class="file-action-btn delete-btn" title="Delete">🗑️</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = filesHTML;

            // Add event listeners to file items
            document.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    // Only trigger preview if not clicking on an action button
                    if (!e.target.closest('.file-action-btn')) {
                        handleFilePreview.call(this, e);
                    }
                });
            });

            // Add event listeners to file action buttons
            document.querySelectorAll('.download-btn').forEach(btn => {
                btn.addEventListener('click', handleFileDownload);
            });

            document.querySelectorAll('.share-btn').forEach(btn => {
                btn.addEventListener('click', handleFileShare);
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', handleFileDelete);
            });
        }

        function getFileIcon(fileType, fileName) {
            // Return appropriate icon based on file type
            if (fileType.startsWith('image/')) {
                return { icon: '🖼️', class: 'file-icon-img' };
            } else if (fileType.startsWith('video/')) {
                return { icon: '🎬', class: 'file-icon-vid' };
            } else if (fileType.startsWith('audio/')) {
                return { icon: '🎵', class: 'file-icon-aud' };
            } else if (fileType === 'application/pdf') {
                return { icon: '📕', class: 'file-icon-pdf' };
            } else if (fileType.includes('word') || fileType.includes('document') ||
                       fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
                return { icon: '📘', class: 'file-icon-doc' };
            } else if (fileType.includes('sheet') || fileType.includes('excel') ||
                       fileName.endsWith('.xls') || fileName.endsWith('.xlsx') ||
                       fileName.endsWith('.csv')) {
                return { icon: '📊', class: 'file-icon-xls' };
            } else if (fileType.includes('presentation') || fileType.includes('powerpoint') ||
                       fileName.endsWith('.ppt') || fileName.endsWith('.pptx')) {
                return { icon: '📙', class: 'file-icon-ppt' };
            } else if (fileType.includes('compressed') || fileType.includes('zip') || fileType.includes('archive') ||
                       fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.7z')) {
                return { icon: '🗜️', class: 'file-icon-zip' };
            } else if (fileType.includes('text') || fileName.endsWith('.txt') || fileName.endsWith('.rtf')) {
                return { icon: '📝', class: 'file-icon-txt' };
            } else {
                return { icon: '📄', class: '' };
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(date) {
            return date.toLocaleDateString();
        }

        function handleFilePreview(e) {
            // Get file data from dataset
            const fileElement = this;
            const fileId = fileElement.dataset.id;
            const fileUrl = fileElement.dataset.url;
            const fileType = fileElement.dataset.type;
            const fileName = fileElement.dataset.name;

            debugLog(`Previewing file: ${fileName} (${fileType}, ID: ${fileId})`, 'info');

            // Set file name in preview modal
            document.getElementById('preview-file-name').textContent = fileName;

            // Get preview container
            const previewContainer = document.getElementById('file-preview-container');

            // Clear previous content
            previewContainer.innerHTML = '';

            // Set up download button
            const downloadBtn = document.getElementById('download-file-btn');
            downloadBtn.onclick = function() {
                window.open(fileUrl, '_blank');
            };

            // Set up share button
            const shareBtn = document.getElementById('share-file-btn');
            shareBtn.onclick = function() {
                handleFileShare(fileId, fileName);
            };

            // Set up delete button
            const deleteBtn = document.getElementById('delete-file-btn');
            deleteBtn.onclick = function() {
                if (confirm(`Are you sure you want to delete ${fileName}?`)) {
                    handleFileDelete(fileId, fileElement);
                    document.getElementById('file-preview-modal').classList.remove('active');
                }
            };

            // Create preview based on file type
            if (fileType.startsWith('image/')) {
                // Image preview
                const img = document.createElement('img');
                img.src = fileUrl;
                img.alt = fileName;
                previewContainer.appendChild(img);
            } else if (fileType.startsWith('video/')) {
                // Video preview
                const video = document.createElement('video');
                video.src = fileUrl;
                video.controls = true;
                video.autoplay = false;
                previewContainer.appendChild(video);
            } else if (fileType.startsWith('audio/')) {
                // Audio preview
                const audio = document.createElement('audio');
                audio.src = fileUrl;
                audio.controls = true;
                previewContainer.appendChild(audio);
            } else if (fileType === 'application/pdf') {
                // PDF preview
                const iframe = document.createElement('iframe');
                iframe.src = fileUrl;
                iframe.className = 'pdf-preview';
                previewContainer.appendChild(iframe);
            } else if (fileType.includes('text') || fileName.endsWith('.txt') || fileName.endsWith('.rtf')) {
                // Text preview - fetch the content
                fetch(fileUrl)
                    .then(response => response.text())
                    .then(text => {
                        const pre = document.createElement('pre');
                        pre.className = 'text-preview';
                        pre.textContent = text;
                        previewContainer.appendChild(pre);
                    })
                    .catch(error => {
                        console.error('Error fetching text file:', error);
                        previewContainer.innerHTML = `<div class="preview-error">Cannot preview this file. <a href="${fileUrl}" target="_blank">Download</a> to view.</div>`;
                    });
            } else {
                // Generic preview for other file types
                const fileIcon = getFileIcon(fileType, fileName);
                previewContainer.innerHTML = `
                    <div class="generic-preview">
                        <div class="large-file-icon ${fileIcon.class}">${fileIcon.icon}</div>
                        <p>Preview not available for this file type.</p>
                        <a href="${fileUrl}" target="_blank" class="btn">Download to view</a>
                    </div>
                `;
            }

            // Show preview modal
            document.getElementById('file-preview-modal').classList.add('active');

            // Update last accessed timestamp
            if (window.firebaseServices && window.firebaseServices.db) {
                window.firebaseServices.db.collection('files').doc(fileId).update({
                    lastAccessed: new Date()
                }).catch(error => {
                    console.error('Error updating last accessed timestamp:', error);
                });
            }
        }

        function handleFileDownload(e) {
            e.stopPropagation();
            const fileItem = e.target.closest('.file-item');
            const fileUrl = fileItem.dataset.url;
            const fileName = fileItem.dataset.name;

            console.log('Downloading file:', fileName);

            // Open the file URL in a new tab to download
            window.open(fileUrl, '_blank');
        }

        function handleFileShare(fileId, fileName) {
            debugLog(`Sharing file: ${fileName} (ID: ${fileId})`, 'info');

            // Check if this is a local file (ID starts with 'file_')
            if (fileId.toString().startsWith('file_')) {
                // For local files, we need to get the URL from our simple upload service
                const user = window.firebaseServices?.auth?.currentUser;
                if (!user) {
                    showNotification('error', 'You must be logged in to share files', 3000);
                    return;
                }

                // Get the file from simple upload service
                window.simpleUploadService.getFile(fileId)
                    .then(fileData => {
                        const shareUrl = fileData.url;

                        // Create a temporary input to copy the URL
                        const tempInput = document.createElement('input');
                        tempInput.value = shareUrl;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);

                        showNotification('success', `Share link for ${fileName} copied to clipboard!`, 3000);
                    })
                    .catch(error => {
                        debugLog(`Error sharing local file: ${error.message}`, 'error');
                        showNotification('error', 'Error sharing file. Please try again.', 3000);
                    });
                return;
            }

            // For cloud files, get the URL from Firestore
            window.firebaseServices.db.collection('files').doc(fileId).get()
                .then(doc => {
                    if (doc.exists) {
                        const fileData = doc.data();
                        const shareUrl = fileData.url;

                        // Create a temporary input to copy the URL
                        const tempInput = document.createElement('input');
                        tempInput.value = shareUrl;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);

                        showNotification('success', `Share link for ${fileName} copied to clipboard!`, 3000);

                        // Update shared status if not already shared
                        if (!fileData.shared) {
                            window.firebaseServices.db.collection('files').doc(fileId).update({
                                shared: true
                            });

                            // Update user's shared files count
                            const user = window.firebaseServices.auth.currentUser;
                            if (user) {
                                window.firebaseServices.db.collection('users').doc(user.uid).update({
                                    sharedFiles: window.firebaseServices.increment(1)
                                });
                            }
                        }
                    } else {
                        showNotification('error', 'File not found!', 3000);
                    }
                })
                .catch(error => {
                    debugLog(`Error sharing cloud file: ${error.message}`, 'error');
                    showNotification('error', 'Error sharing file. Please try again.', 3000);
                });
        }

        function handleFileDelete(fileId, fileElement) {
            debugLog('Deleting file: ' + fileId);

            if (!window.firebaseServices || !window.firebaseServices.auth.currentUser) {
                alert('You must be logged in to delete files.');
                return;
            }

            const user = window.firebaseServices.auth.currentUser;

            // Check if this is a local file (ID starts with 'file_')
            if (fileId.toString().startsWith('file_')) {
                // This is a local file, delete using simple upload service
                window.simpleUploadService.deleteFile(fileId)
                    .then(() => {
                        debugLog('Local file deleted successfully', 'success');
                        showNotification('success', 'File deleted successfully', 3000);

                        // Remove file element from UI if it exists
                        if (fileElement) {
                            fileElement.remove();
                        }

                        // Refresh file list
                        fetchUserFiles(user.uid);
                    })
                    .catch(error => {
                        debugLog('Error deleting local file: ' + error.message, 'error');
                        showNotification('error', 'Error deleting file. Please try again.', 3000);
                    });
                return;
            }

            // This is a cloud file, delete from Firebase
            // Get file data first
            window.firebaseServices.db.collection('files').doc(fileId).get()
                .then(doc => {
                    if (!doc.exists) {
                        showNotification('error', 'File not found!', 3000);
                        return;
                    }

                    const fileData = doc.data();

                    // Check if user owns the file
                    if (fileData.userId !== user.uid) {
                        showNotification('error', 'You do not have permission to delete this file.', 3000);
                        return;
                    }

                    // Delete from Storage
                    const storageRef = window.firebaseServices.storage.ref(fileData.path);
                    return storageRef.delete()
                        .then(() => {
                            debugLog('File deleted from Storage', 'success');

                            // Delete from Firestore
                            return window.firebaseServices.db.collection('files').doc(fileId).delete();
                        })
                        .then(() => {
                            debugLog('File deleted from Firestore', 'success');

                            // Update user's storage usage and file count
                            return window.firebaseServices.db.collection('users').doc(user.uid).update({
                                storageUsed: window.firebaseServices.increment(-fileData.size),
                                fileCount: window.firebaseServices.increment(-1),
                                sharedFiles: fileData.shared ? window.firebaseServices.increment(-1) : window.firebaseServices.increment(0)
                            });
                        })
                        .then(() => {
                            showNotification('success', 'File deleted successfully!', 3000);

                            // Remove file element from UI if it exists
                            if (fileElement) {
                                fileElement.remove();
                            }

                            // Refresh file list
                            fetchUserFiles(user.uid);
                        });
                })
                .catch(error => {
                    debugLog('Error deleting cloud file: ' + error.message, 'error');
                    showNotification('error', 'Error deleting file. Please try again.', 3000);
                });
        }

        function handleFileUpload() {
            // Create a file input element
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = '*/*'; // Accept all file types

            // Trigger click event to open file dialog
            fileInput.click();

            // Handle file selection
            fileInput.addEventListener('change', async function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    // Show upload modal
                    const uploadModal = document.getElementById('upload-modal');
                    uploadModal.classList.add('active');

                    // Update upload count
                    document.getElementById('upload-count').textContent = `0/${files.length}`;

                    // Reset progress bar
                    const progressBar = document.getElementById('upload-progress-bar');
                    const progressText = document.getElementById('upload-progress-text');
                    const statusText = document.getElementById('upload-status');
                    progressBar.style.width = '0%';
                    progressText.textContent = '0%';
                    statusText.textContent = 'Preparing files...';

                    try {
                        // Use the free user upload service for reliable uploads with 5MB limit
                        console.log('Using free user upload service with 5MB limit');

                        // Initialize the local-only upload service as fallback
                        console.log('Local-only upload service initialized as fallback');

                        // Log the upload strategy
                        console.log('Upload strategy: Free User (5MB limit) → Local-Only');

                        // Show notification about file size limit
                        showNotification('info', 'Free users can upload files up to 5MB', 5000);

                        // Process files with optimized compression for images
                        const imageCompressor = new ImageCompressor({
                            quality: 0.6,       // 60% quality for faster uploads
                            maxWidth: 1280,      // Reduced dimensions for faster processing
                            maxHeight: 720,
                            convertTypes: ['image/png', 'image/webp', 'image/bmp'], // Convert these to JPEG
                            aggressiveCompression: true,  // Enable aggressive compression
                            concurrentProcessing: 2       // Process 2 images at a time
                        });

                        statusText.textContent = 'Optimizing images...';
                        const processedFiles = await imageCompressor.processFiles(files);
                        statusText.textContent = 'Starting optimized upload...';

                        // Use our free user upload service with 5MB limit
                        uploadFilesToFirebaseFast(processedFiles);
                    } catch (error) {
                        console.error('Error processing files:', error);
                        statusText.textContent = 'Error preparing files. Using direct upload...';
                        // Fall back to original files with regular upload if optimization fails
                        uploadFilesToFirebase(files);
                    }
                }
            });
        }

        function uploadFilesToFirebase(files) {
            if (!window.firebaseServices) {
                alert('Error: Firebase services not available or user not logged in');
                document.getElementById('upload-modal').classList.remove('active');
                return;
            }

            const user = window.firebaseServices.auth.currentUser;
            if (!user) {
                alert('Error: You must be logged in to upload files');
                document.getElementById('upload-modal').classList.remove('active');
                return;
            }

            // Initialize local storage manager for fallback
            const localStorageManager = new LocalStorageManager();

            // Validate files
            const validFiles = [];
            const largeFiles = [];
            const MAX_FIREBASE_SIZE = 50 * 1024 * 1024; // 50MB for Firebase
            const MAX_LOCAL_SIZE = 200 * 1024 * 1024;   // 200MB for local storage
            const MAX_TOTAL_SIZE = 500 * 1024 * 1024;   // 500MB total upload limit
            let totalUploadSize = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Check if file is too large for any storage
                if (file.size > MAX_LOCAL_SIZE) {
                    alert(`File "${file.name}" exceeds the 200MB size limit. It will be skipped.`);
                    continue;
                }

                // Check if file is too large for Firebase but can be stored locally
                if (file.size > MAX_FIREBASE_SIZE) {
                    largeFiles.push(file);
                    continue;
                }

                totalUploadSize += file.size;
                if (totalUploadSize > MAX_TOTAL_SIZE) {
                    alert(`Total upload size exceeds 500MB limit. Only the first ${validFiles.length} files will be uploaded.`);
                    break;
                }

                validFiles.push(file);
            }

            // Handle large files separately
            if (largeFiles.length > 0) {
                const largeFileNames = largeFiles.map(f => f.name).join(', ');
                const confirmLocal = confirm(`${largeFiles.length} file(s) are too large for cloud storage (${largeFileNames}). Would you like to store them locally in your browser instead?`);

                if (confirmLocal) {
                    // Process large files with local storage
                    processLocalFiles(largeFiles, user.uid);
                }
            }

            if (validFiles.length === 0 && largeFiles.length === 0) {
                alert('No valid files to upload.');
                document.getElementById('upload-modal').classList.remove('active');
                return;
            } else if (validFiles.length === 0 && largeFiles.length > 0) {
                // If we only have large files and user confirmed local storage, we're done
                if (confirmLocal) {
                    return;
                }
                document.getElementById('upload-modal').classList.remove('active');
                return;
            }

            const totalFiles = validFiles.length;
            let uploadedFiles = 0;
            let failedFiles = 0;
            let locallyStoredFiles = 0;
            let totalBytes = 0;
            let uploadedBytes = 0;
            let cancelUpload = false;

            // Setup cancel button
            const cancelBtn = document.getElementById('cancel-upload-btn');
            const cancelHandler = function() {
                cancelUpload = true;
                document.getElementById('upload-modal').classList.remove('active');
                alert('Upload cancelled');
            };
            cancelBtn.addEventListener('click', cancelHandler);

            // Calculate total size
            for (let i = 0; i < validFiles.length; i++) {
                totalBytes += validFiles[i].size;
            }

            // Update progress elements
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');
            const currentFileName = document.getElementById('current-file-name');
            const uploadCount = document.getElementById('upload-count');
            const statusText = document.getElementById('upload-status');

            // Process each file
            processNextFile(0);

            function processNextFile(index) {
                if (index >= validFiles.length || cancelUpload) {
                    if (!cancelUpload) {
                        // Remove event listener to prevent memory leaks
                        cancelBtn.removeEventListener('click', cancelHandler);

                        // Show summary
                        let summaryMessage = `Upload complete. ${uploadedFiles} files uploaded to cloud`;
                        if (failedFiles > 0) {
                            summaryMessage += `, ${failedFiles} files failed`;
                        }
                        if (locallyStoredFiles > 0) {
                            summaryMessage += `, ${locallyStoredFiles} files stored locally`;
                        }
                        alert(summaryMessage);

                        finishUpload(user.uid);
                    }
                    return;
                }

                const file = validFiles[index];
                const fileName = file.name;
                const fileSize = file.size;
                const fileType = file.type;

                // Update UI
                currentFileName.textContent = fileName;
                uploadCount.textContent = `${index + 1}/${validFiles.length}`;

                // Get file category
                const fileCategory = getFileCategory(fileType, fileName);

                console.log(`Uploading file: ${fileName} (${fileCategory})`);

                // Show initial progress for this file
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                statusText.textContent = `Uploading ${fileName} to cloud...`;

                // Use the Firebase v9 SDK uploadFile function with timeout handling
                const uploadStartTime = new Date().getTime();

                window.firebaseServices.uploadFile(user.uid, file)
                    .then((uploadResult) => {
                        const uploadTime = (new Date().getTime() - uploadStartTime) / 1000;
                        console.log(`File uploaded successfully in ${uploadTime.toFixed(2)} seconds:`, uploadResult.downloadURL);
                        statusText.textContent = `File uploaded in ${uploadTime.toFixed(1)} seconds. Saving metadata...`;

                        // Create file metadata in Firestore
                        const fileData = {
                            name: fileName,
                            type: fileType,
                            category: fileCategory,
                            size: fileSize,
                            url: uploadResult.downloadURL,
                            path: uploadResult.path,
                            userId: user.uid,
                            createdAt: new Date(),
                            lastAccessed: new Date(),
                            shared: false,
                            uploadTime: uploadTime,
                            isLocal: false
                        };

                        // Add file to Firestore
                        return window.firebaseServices.db.collection('files').add(fileData)
                            .then((docRef) => {
                                console.log('File document created with ID:', docRef.id);

                                // Update user's storage usage and file count
                                return window.firebaseServices.db.collection('users').doc(user.uid).update({
                                    storageUsed: window.firebaseServices.increment(fileSize),
                                    fileCount: window.firebaseServices.increment(1)
                                });
                            })
                            .then(() => {
                                // Update progress
                                uploadedBytes += fileSize;
                                uploadedFiles++;

                                const overallProgress = Math.round((uploadedBytes / totalBytes) * 100);
                                progressBar.style.width = `${overallProgress}%`;
                                progressText.textContent = `${overallProgress}%`;
                                statusText.textContent = `${fileName} processed successfully.`;

                                // Process next file
                                processNextFile(index + 1);
                            });
                    })
                    .catch((error) => {
                        console.error('Upload error:', error);
                        statusText.textContent = `Error uploading to cloud. Trying local storage...`;

                        // Try to store locally instead
                        localStorageManager.init()
                            .then(() => localStorageManager.saveFile(user.uid, file))
                            .then((localFile) => {
                                console.log('File stored locally:', localFile);
                                statusText.textContent = `${fileName} stored locally.`;
                                locallyStoredFiles++;

                                // Update progress
                                uploadedBytes += fileSize;
                                const overallProgress = Math.round((uploadedBytes / totalBytes) * 100);
                                progressBar.style.width = `${overallProgress}%`;
                                progressText.textContent = `${overallProgress}%`;

                                // Process next file
                                processNextFile(index + 1);
                            })
                            .catch((localError) => {
                                console.error('Local storage error:', localError);
                                alert(`Error uploading ${fileName}: ${error.message}. Local storage also failed.`);
                                statusText.textContent = `Error storing ${fileName}. Continuing with next file...`;

                                failedFiles++;

                                // Update progress (count failed file as processed)
                                uploadedBytes += fileSize; // Count in total for progress calculation
                                const overallProgress = Math.round((uploadedBytes / totalBytes) * 100);
                                progressBar.style.width = `${overallProgress}%`;
                                progressText.textContent = `${overallProgress}%`;

                                // Continue with next file
                                processNextFile(index + 1);
                            });
                    });
            }

            // Function to process files that are too large for Firebase
            async function processLocalFiles(largeFiles, userId) {
                try {
                    await localStorageManager.init();

                    for (let i = 0; i < largeFiles.length; i++) {
                        const file = largeFiles[i];
                        statusText.textContent = `Storing ${file.name} locally (${i+1}/${largeFiles.length})...`;

                        try {
                            const localFile = await localStorageManager.saveFile(userId, file);
                            console.log('Large file stored locally:', localFile);
                            locallyStoredFiles++;
                        } catch (error) {
                            console.error('Error storing large file locally:', error);
                            failedFiles++;
                        }
                    }

                    statusText.textContent = `${locallyStoredFiles} large files stored locally.`;

                    // If we're not uploading any cloud files, close the modal
                    if (validFiles.length === 0) {
                        setTimeout(() => {
                            document.getElementById('upload-modal').classList.remove('active');
                            fetchUserFiles(userId);
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error initializing local storage:', error);
                    alert('Error: Could not initialize local storage for large files.');
                }
            }
        }

        function getFileCategory(fileType, fileName) {
            // Determine file category based on MIME type or extension
            if (fileType.startsWith('image/')) {
                return 'images';
            } else if (fileType.startsWith('video/')) {
                return 'videos';
            } else if (fileType.startsWith('audio/')) {
                return 'audio';
            } else if (fileType === 'application/pdf') {
                return 'documents';
            } else if (fileType.includes('word') || fileType.includes('document') ||
                       fileName.endsWith('.doc') || fileName.endsWith('.docx') ||
                       fileName.endsWith('.txt') || fileName.endsWith('.rtf')) {
                return 'documents';
            } else if (fileType.includes('sheet') || fileType.includes('excel') ||
                       fileName.endsWith('.xls') || fileName.endsWith('.xlsx') ||
                       fileName.endsWith('.csv')) {
                return 'documents';
            } else if (fileType.includes('presentation') || fileType.includes('powerpoint') ||
                       fileName.endsWith('.ppt') || fileName.endsWith('.pptx')) {
                return 'documents';
            } else if (fileType.includes('compressed') || fileType.includes('zip') || fileType.includes('archive') ||
                       fileName.endsWith('.zip') || fileName.endsWith('.rar') || fileName.endsWith('.7z')) {
                return 'archives';
            } else {
                return 'other';
            }
        }

        /**
         * Free user upload function with 5MB limit
         * @param {Array} files - The files to upload
         */
        function uploadFilesToFirebaseFast(files) {
            if (!window.firebaseServices) {
                alert('Error: Firebase services not available or user not logged in');
                document.getElementById('upload-modal').classList.remove('active');
                return;
            }

            const user = window.firebaseServices.auth.currentUser;
            if (!user) {
                alert('Error: You must be logged in to upload files');
                document.getElementById('upload-modal').classList.remove('active');
                return;
            }

            // Validate files
            const validFiles = [];
            const largeFiles = [];
            const MAX_FREE_USER_SIZE = 5 * 1024 * 1024; // 5MB for free users
            const MAX_TOTAL_SIZE = 20 * 1024 * 1024;   // 20MB total upload limit for free users
            let totalUploadSize = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];

                // Check if file is too large for free users
                if (file.size > MAX_FREE_USER_SIZE) {
                    alert(`File "${file.name}" exceeds the 5MB size limit for free users. It will be skipped.`);
                    continue;
                }

                totalUploadSize += file.size;
                if (totalUploadSize > MAX_TOTAL_SIZE) {
                    alert(`Total upload size exceeds 20MB limit for free users. Only the first ${validFiles.length} files will be uploaded.`);
                    break;
                }

                validFiles.push(file);
            }

            if (validFiles.length === 0) {
                alert('No valid files to upload. Please select files under 5MB.');
                document.getElementById('upload-modal').classList.remove('active');
                return;
            }

            const totalFiles = validFiles.length;
            let uploadedFiles = 0;
            let failedFiles = 0;
            let locallyStoredFiles = 0;
            let cancelUpload = false;

            // Setup cancel button
            const cancelBtn = document.getElementById('cancel-upload-btn');
            const cancelHandler = function() {
                cancelUpload = true;
                document.getElementById('upload-modal').classList.remove('active');
                alert('Upload cancelled');
            };
            cancelBtn.addEventListener('click', cancelHandler);

            // Update progress elements
            const progressBar = document.getElementById('upload-progress-bar');
            const progressText = document.getElementById('upload-progress-text');
            const currentFileName = document.getElementById('current-file-name');
            const uploadCount = document.getElementById('upload-count');
            const statusText = document.getElementById('upload-status');

            // Process each file
            processNextFile(0);

            function processNextFile(index) {
                if (index >= validFiles.length || cancelUpload) {
                    if (!cancelUpload) {
                        // Remove event listener to prevent memory leaks
                        cancelBtn.removeEventListener('click', cancelHandler);

                        // Create summary message
                        let summaryMessage = `Upload complete. ${uploadedFiles} files uploaded to cloud`;
                        if (failedFiles > 0) {
                            summaryMessage += `, ${failedFiles} files failed`;
                        }
                        if (locallyStoredFiles > 0) {
                            summaryMessage += `, ${locallyStoredFiles} files stored locally`;
                        }

                        // Log completion
                        debugLog(`Upload process complete: ${summaryMessage}`, 'success');

                        // Show notification instead of alert
                        showNotification('success', summaryMessage, 5000);

                        // Finish upload process
                        finishUpload(user.uid);
                    }
                    return;
                }

                const file = validFiles[index];
                const fileName = file.name;
                const fileSize = file.size;
                const fileType = file.type;

                // Update UI
                currentFileName.textContent = fileName;
                uploadCount.textContent = `${index + 1}/${validFiles.length}`;

                // Get file category
                const fileCategory = getFileCategory(fileType, fileName);

                console.log(`Fast uploading file: ${fileName} (${fileCategory})`);

                // Show initial progress for this file
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                statusText.textContent = `Uploading ${fileName} to cloud...`;

                // Use the simple upload service with progress tracking
                const uploadStartTime = new Date().getTime();

                // Try simple upload first, then try direct upload, then fall back to fast upload if needed
                console.log(`Uploading ${fileName} using simple upload service`);

                // Define a function to update the progress UI
                const updateProgress = (progress, statusMessage) => {
                    // Update progress UI
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;
                    if (statusMessage) {
                        statusText.textContent = statusMessage;
                    }
                };

                // Check file size
                const fileSizeMB = file.size / (1024 * 1024);
                const maxFileSizeMB = 5; // 5MB limit for free users

                if (fileSizeMB > maxFileSizeMB) {
                    updateProgress(0, `Error: File exceeds ${maxFileSizeMB}MB limit for free users`);
                    console.error(`File ${fileName} exceeds ${maxFileSizeMB}MB limit for free users`);

                    // Show error message
                    showNotification('error', `File exceeds ${maxFileSizeMB}MB limit for free users`, 5000);

                    // Remove the upload item
                    setTimeout(() => {
                        uploadItem.remove();
                    }, 3000);

                    return;
                }

                // Use the direct upload service for reliable uploads
                debugLog(`Starting direct upload of ${fileName} (${(fileSize / (1024 * 1024)).toFixed(2)}MB)`);

                window.directUploadService.uploadFile(user.uid, file, updateProgress)
                .then(uploadResult => {
                    const uploadTime = (new Date().getTime() - uploadStartTime) / 1000;
                    debugLog(`File uploaded successfully in ${uploadTime.toFixed(2)} seconds`, 'success');

                    // Update progress
                    uploadedFiles++;
                    const overallProgress = Math.round(((index + 1) / validFiles.length) * 100);
                    updateProgress(overallProgress, `${fileName} uploaded successfully in ${uploadTime.toFixed(1)} seconds`);

                    // Show notification
                    showNotification('success', `File ${fileName} uploaded successfully`, 3000);

                    // Force UI update
                    window.directFileManager.updateUI();

                    // Process next file
                    processNextFile(index + 1);
                })
                .catch(error => {
                    debugLog(`Upload failed for ${fileName}: ${error.message}`, 'error');
                    failedFiles++;

                    // Update progress
                    const overallProgress = Math.round(((index + 1) / validFiles.length) * 100);
                    updateProgress(overallProgress, `Failed to upload ${fileName}. Continuing...`);

                    // Show notification
                    showNotification('error', `Failed to upload ${fileName}`, 3000);

                    // Process next file
                    processNextFile(index + 1);
                });
            }


        }

        /**
         * Show a notification to the user
         * @param {string} type - The type of notification (success, error, info, warning)
         * @param {string} message - The message to display
         * @param {number} duration - How long to show the notification in milliseconds
         */
        function showNotification(type, message, duration = 3000) {
            // Create notification element if it doesn't exist
            let notification = document.getElementById('notification');
            if (!notification) {
                notification = document.createElement('div');
                notification.id = 'notification';
                document.body.appendChild(notification);

                // Add styles
                notification.style.position = 'fixed';
                notification.style.bottom = '20px';
                notification.style.right = '20px';
                notification.style.padding = '15px 20px';
                notification.style.borderRadius = '5px';
                notification.style.color = '#fff';
                notification.style.fontWeight = 'bold';
                notification.style.zIndex = '9999';
                notification.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
                notification.style.transition = 'all 0.3s ease';
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(20px)';
            }

            // Set type-specific styles
            if (type === 'success') {
                notification.style.backgroundColor = '#00c853';
            } else if (type === 'error') {
                notification.style.backgroundColor = '#ff3d00';
            } else if (type === 'warning') {
                notification.style.backgroundColor = '#ffa000';
            } else if (type === 'info') {
                notification.style.backgroundColor = '#00b0ff';
            }

            // Set message
            notification.textContent = message;

            // Show notification
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);

            // Hide notification after duration
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(20px)';
            }, duration);
        }

        function finishUpload(userId) {
            debugLog('Finishing upload process', 'info');

            // Close upload modal
            document.getElementById('upload-modal').classList.remove('active');

            // Update UI directly using our direct file manager
            window.directFileManager.updateUI();

            // Show success notification
            showNotification('success', 'Upload process completed', 3000);
        }

        function updateUIForLoggedOutUser() {
            // Update login button
            const loginLink = document.getElementById('login-link');
            loginLink.textContent = 'Login';
            loginLink.href = '#';

            // Remove existing event listeners by cloning the node
            const newLoginLink = loginLink.cloneNode(true);
            loginLink.parentNode.replaceChild(newLoginLink, loginLink);

            // Add the event listener to the new node
            newLoginLink.addEventListener('click', showLoginModal);

            // Reset Get Started button text
            const getStartedBtn = document.getElementById('get-started-btn');
            getStartedBtn.textContent = 'Get Started';

            // Remove logout button if it exists
            const logoutLink = document.getElementById('logout-link');
            if (logoutLink) {
                logoutLink.parentNode.removeChild(logoutLink);
            }
        }

        function showLoginModal(e) {
            e.preventDefault();
            document.getElementById('login-section').classList.add('active');
        }

        // Form submissions
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Signing in...';
            submitBtn.disabled = true;

            console.log('Attempting login with:', email);

            // Log login attempt details (without password)
            console.log('Login attempt:', { email });
            console.log('Firebase config being used:', firebaseConfig);

            // Check if Firebase services are available
            if (!window.firebaseServices) {
                alert('Firebase services are not yet initialized. Please try again in a moment.');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }

            // Firebase login with v9 SDK and detailed error handling
            window.firebaseServices.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    console.log('Login successful:', user.email);
                    document.getElementById('login-section').classList.remove('active');

                    // Track login event with analytics
                    window.firebaseServices.logAnalyticsEvent('login', {
                        method: 'email'
                    });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error('Login error details:', { code: errorCode, message: errorMessage, fullError: error });

                    // Show user-friendly error messages
                    let userMessage = 'Login failed. Please try again.';
                    if (errorCode === 'auth/user-not-found' || errorCode === 'auth/wrong-password') {
                        userMessage = 'Invalid email or password. Please try again.';
                    } else if (errorCode === 'auth/too-many-requests') {
                        userMessage = 'Too many failed login attempts. Please try again later.';
                    } else if (errorCode === 'auth/user-disabled') {
                        userMessage = 'This account has been disabled. Please contact support.';
                    } else if (errorCode === 'auth/network-request-failed') {
                        userMessage = 'Network error. Please check your internet connection and try again.';
                    } else if (errorCode === 'auth/invalid-email') {
                        userMessage = 'Please enter a valid email address.';
                    }

                    alert(userMessage);
                })
                .finally(() => {
                    // Reset button
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });

        document.getElementById('register-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;

            // Validate passwords match
            if (password !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            // Validate password strength
            if (password.length < 6) {
                alert('Password must be at least 6 characters long.');
                return;
            }

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating account...';
            submitBtn.disabled = true;

            console.log('Attempting registration with:', email);

            // Log registration attempt details (without password)
            console.log('Registration attempt:', { email, name });
            console.log('Firebase config being used:', firebaseConfig);

            // Check if Firebase services are available
            if (!window.firebaseServices) {
                alert('Firebase services are not yet initialized. Please try again in a moment.');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                return;
            }

            // Firebase registration with v9 SDK and detailed error handling
            window.firebaseServices.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    console.log('Registration successful:', user.email);

                    // Update profile with name
                    return window.firebaseServices.updateProfile(user, {
                        displayName: name
                    }).then(() => {
                        document.getElementById('register-section').classList.remove('active');
                        alert('Account created successfully!');

                        // Track registration event with analytics
                        window.firebaseServices.logAnalyticsEvent('sign_up', {
                            method: 'email'
                        });

                        // Create user document in Firestore
                        window.firebaseServices.createUserDocument(user.uid, {
                            name: name,
                            email: email,
                            storageUsed: 0,
                            fileCount: 0,
                            sharedFiles: 0
                        }).catch(firestoreError => {
                            console.error('Error creating user document:', firestoreError);
                        });
                    }).catch(profileError => {
                        console.error('Error updating user profile:', profileError);
                        alert('Account created, but profile could not be updated. Please try again later.');
                    });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.error('Registration error details:', { code: errorCode, message: errorMessage, fullError: error });

                    // Show user-friendly error messages
                    let userMessage = 'Registration failed. Please try again.';
                    if (errorCode === 'auth/email-already-in-use') {
                        userMessage = 'This email is already registered. Please use a different email or try logging in.';
                    } else if (errorCode === 'auth/invalid-email') {
                        userMessage = 'Please enter a valid email address.';
                    } else if (errorCode === 'auth/weak-password') {
                        userMessage = 'Password is too weak. Please choose a stronger password.';
                    } else if (errorCode === 'auth/operation-not-allowed') {
                        userMessage = 'Email/password accounts are not enabled. Please contact support.';
                    } else if (errorCode === 'auth/network-request-failed') {
                        userMessage = 'Network error. Please check your internet connection and try again.';
                    }

                    alert(userMessage);
                })
                .finally(() => {
                    // Reset button
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });

        // Contact form submission
        document.getElementById('contact-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('contact-name').value;
            const email = document.getElementById('contact-email').value;
            const subject = document.getElementById('contact-subject').value;
            const message = document.getElementById('contact-message').value;

            // In a real app, you would send this to your backend
            alert(`Thank you for your message, ${name}! We will get back to you soon.`);

            // Reset form
            this.reset();
        });

        // Google Sign-in for Login
        document.getElementById('google-login-btn').addEventListener('click', function() {
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<div class="loading-spinner"></div> Signing in...';
            this.disabled = true;

            // Check if Firebase services are available
            if (!window.firebaseServices) {
                alert('Firebase services are not yet initialized. Please try again in a moment.');
                this.innerHTML = originalText;
                this.disabled = false;
                return;
            }

            // Sign in with Google
            window.firebaseServices.signInWithGoogle()
                .then((result) => {
                    // Google sign-in successful
                    const user = result.user;
                    console.log('Google sign-in successful:', user.email);
                    document.getElementById('login-section').classList.remove('active');

                    // Track login event with analytics
                    window.firebaseServices.logAnalyticsEvent('login', {
                        method: 'google'
                    });

                    // Check if user document exists, if not create one
                    window.firebaseServices.getUserDocument(user.uid)
                        .then((userData) => {
                            if (!userData) {
                                // Create user document for Google sign-in
                                return window.firebaseServices.createUserDocument(user.uid, {
                                    name: user.displayName || '',
                                    email: user.email,
                                    photoURL: user.photoURL || '',
                                    storageUsed: 0,
                                    fileCount: 0,
                                    sharedFiles: 0,
                                    provider: 'google'
                                });
                            }
                        })
                        .catch(error => {
                            console.error('Error checking/creating user document:', error);
                        });
                })
                .catch((error) => {
                    console.error('Google sign-in error:', error);
                    let errorMessage = 'Google sign-in failed. Please try again.';

                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Sign-in cancelled. You closed the Google sign-in popup.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'Pop-up was blocked by your browser. Please allow pop-ups for this website.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Sign-in cancelled. Multiple pop-up requests detected.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Please check your internet connection and try again.';
                    }

                    alert(errorMessage);
                })
                .finally(() => {
                    // Reset button
                    this.innerHTML = originalText;
                    this.disabled = false;
                });
        });

        // Google Sign-in for Registration
        document.getElementById('google-register-btn').addEventListener('click', function() {
            // Show loading state
            const originalText = this.innerHTML;
            this.innerHTML = '<div class="loading-spinner"></div> Signing up...';
            this.disabled = true;

            // Check if Firebase services are available
            if (!window.firebaseServices) {
                alert('Firebase services are not yet initialized. Please try again in a moment.');
                this.innerHTML = originalText;
                this.disabled = false;
                return;
            }

            // Sign in with Google (same process as login, but with different analytics event)
            window.firebaseServices.signInWithGoogle()
                .then((result) => {
                    // Google sign-in successful
                    const user = result.user;
                    console.log('Google sign-up successful:', user.email);
                    document.getElementById('register-section').classList.remove('active');

                    // Track registration event with analytics
                    window.firebaseServices.logAnalyticsEvent('sign_up', {
                        method: 'google'
                    });

                    // Check if user document exists, if not create one
                    window.firebaseServices.getUserDocument(user.uid)
                        .then((userData) => {
                            if (!userData) {
                                // Create user document for Google sign-in
                                return window.firebaseServices.createUserDocument(user.uid, {
                                    name: user.displayName || '',
                                    email: user.email,
                                    photoURL: user.photoURL || '',
                                    storageUsed: 0,
                                    fileCount: 0,
                                    sharedFiles: 0,
                                    provider: 'google'
                                }).then(() => {
                                    alert('Account created successfully with Google!');
                                });
                            } else {
                                // User already exists
                                console.log('User document already exists');
                            }
                        })
                        .catch(error => {
                            console.error('Error checking/creating user document:', error);
                        });
                })
                .catch((error) => {
                    console.error('Google sign-up error:', error);
                    let errorMessage = 'Google sign-up failed. Please try again.';

                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = 'Sign-up cancelled. You closed the Google sign-in popup.';
                    } else if (error.code === 'auth/popup-blocked') {
                        errorMessage = 'Pop-up was blocked by your browser. Please allow pop-ups for this website.';
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = 'Sign-up cancelled. Multiple pop-up requests detected.';
                    } else if (error.code === 'auth/network-request-failed') {
                        errorMessage = 'Network error. Please check your internet connection and try again.';
                    }

                    alert(errorMessage);
                })
                .finally(() => {
                    // Reset button
                    this.innerHTML = originalText;
                    this.disabled = false;
                });
        });

        // Smooth scrolling for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function(e) {
                if (this.getAttribute('href') === '#') return;

                e.preventDefault();

                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });

        // Initialize direct file manager when user logs in
        window.addEventListener('userLoggedIn', function(e) {
            if (e.detail && e.detail.user) {
                console.log('User logged in event detected, initializing direct file manager');
                setTimeout(() => {
                    window.directFileManager.updateUI();
                }, 1000);
            }
        });

        // Also initialize when files container is shown
        document.getElementById('files-container').addEventListener('DOMNodeInserted', function(e) {
            console.log('Files container updated, checking if direct file manager needs to update');
            if (window.firebaseServices?.auth?.currentUser) {
                window.directFileManager.updateUI();
            }
        });

        // Add a function to directly update the files list
        window.updateFilesList = function() {
            console.log('Direct update of files list requested');
            if (window.firebaseServices?.auth?.currentUser) {
                window.directFileManager.updateUI();
                return true;
            }
            return false;
        };

        // Call updateFilesList every 5 seconds to ensure files are displayed
        setInterval(window.updateFilesList, 5000);
    </script>
</body>
</html>
